## 快速索引功能

### 整体架构

快速索引功能通过 **MongoDB 索引机制**实现，主要包括两个层面：
1. **索引创建层**：在数据库初始化时创建多种类型的索引
2. **索引使用层**：在搜索查询时利用索引加速查询

### 索引创建（`be/model/store.py`）

**新增方法：`init_collections()`**

#### 创建的索引类型

##### 单字段索引（快速精确查询）
```python
# 书名索引
self.db.store.create_index([("book_title", pymongo.ASCENDING)])

# 作者索引
self.db.store.create_index([("book_author", pymongo.ASCENDING)])

# 标签索引（支持数组字段的多键索引）
self.db.store.create_index([("book_tags", pymongo.ASCENDING)])
```

**作用：**
- 加速按书名、作者、标签的精确查询
- `book_tags` 使用 **多键索引（multikey index）**，支持数组字段的高效查询

##### 复合文本索引（全文搜索）
```python
# 文本索引：跨字段关键词搜索
self.db.store.create_index([
    ("book_title", pymongo.TEXT),
    ("book_author", pymongo.TEXT),
    ("book_tags", pymongo.TEXT),
], name="store_text_idx")
```

**作用：**
- 在 `book_title`、`book_author`、`book_tags` 三个字段上创建**复合文本索引**
- 支持跨字段的关键词全文搜索
- 自动计算相关性分数（textScore）

##### 唯一索引（数据完整性）
```python
# 复合唯一索引：确保同一店铺中图书ID唯一
self.db.store.create_index([("store_id", pymongo.ASCENDING), ("book_id", pymongo.ASCENDING)], unique=True)
```

#### 异常处理
```python
try:
    self.db.store.create_index([...], name="store_text_idx")
except Exception:
    # 忽略索引已存在或不支持的情况
    pass
```

**原因：** 防止重复创建索引导致错误

### 索引使用（`be/model/buyer.py`）

#### 基础搜索（`book_search`）
**使用场景：** 精确字段匹配

**实现方式：**

- 使用单字段索引加速查询
- 通过 `$regex` 进行模糊匹配（大小写不敏感）

```python
query_conditions["book_title"] = {"$regex": book_title, "$options": "i"}
query_conditions["book_tags"] = {"$all": book_tags}
```

**索引利用：**
- `book_title` 索引：加速书名正则匹配
- `book_tags` 多键索引：加速标签数组查询

#### 高级搜索（`book_search_advanced`）
**使用场景：** 关键词全文搜索 + 多条件过滤 + 分页排序

##### 文本索引查询（核心功能）
```python
if keyword:
    # 使用文本索引进行全文搜索
    query["$text"] = {"$search": keyword}
    
    # 获取相关性分数
    projection["score"] = {"$meta": "textScore"}
    
    # 按相关性排序
    if sort == "relevance":
        sort_spec = [("score", {"$meta": "textScore"})]
```

**工作流程：**
1. 使用 `$text` 查询操作符触发文本索引
2. 在 `book_title`、`book_author`、`book_tags` 三个字段中搜索关键词
3. MongoDB 自动计算相关性分数（textScore）
4. 按相关性分数排序，最相关的结果排在前面

##### 组合查询（文本索引 + 其他条件）
```python
# 文本索引查询
query["$text"] = {"$search": keyword}

# 店铺过滤（使用 store_id 索引）
if store_id:
    query["store_id"] = store_id

# 作者过滤（使用 book_author 索引）
if author:
    query["book_author"] = {"$regex": author, "$options": "i"}

# 标签过滤（使用 book_tags 多键索引）
if tags:
    query["book_tags"] = {"$in": tags}
```

**索引协同：**
- 文本索引处理关键词搜索
- 单字段索引处理精确过滤条件
- MongoDB 查询优化器自动选择最优索引组合

##### 排序与分页
```python
# 按相关性分数排序（使用 textScore）
sort_spec = [("score", {"$meta": "textScore"})]

# 或按其他字段排序（使用相应索引）
if sort == "title_asc":
    sort_spec = [("book_title", 1)]  # 使用 book_title 索引

# 分页
cursor = cursor.skip((page - 1) * page_size).limit(page_size)
```

### 性能优化策略

#### 索引选择策略

| 查询类型 | 使用的索引 | 优势 |
|---------|-----------|------|
| 关键词搜索 | 文本索引（复合） | O(log n) 复杂度，支持跨字段搜索 |
| 精确匹配 | 单字段索引 | 直接定位，无需全文扫描 |
| 数组查询 | 多键索引 | 高效处理标签数组查询 |
| 组合查询 | 索引合并 | 多个索引协同工作 |

#### 查询优化

1. **相关性排序：** 使用 `textScore` 元数据，按搜索相关性排序
2. **索引覆盖：** 查询时尽量使用索引字段，减少全表扫描
3. **分页优化：** 使用 `skip()` 和 `limit()` 限制返回结果数量
4. **投影优化：** 只返回需要的字段，减少数据传输

### 关键技术点

#### 文本索引特性
- **跨字段搜索：** 一个关键词可在多个字段中搜索
- **相关性评分：** 自动计算搜索相关性，支持按相关性排序
- **中文支持：** MongoDB 文本索引支持中文分词（取决于版本）

#### 多键索引
- **数组字段支持：** `book_tags` 是数组，使用多键索引后每个标签值都会被索引
- **查询效率：** `{"book_tags": {"$in": [...}}` 查询会利用多键索引加速

#### 索引组合
- MongoDB 查询优化器会自动选择最优索引组合
- 文本索引可以与普通索引组合使用，提升复合查询性能

### 实现优势

1. **查询速度快：** 索引将查询复杂度从 O(n) 降低到 O(log n)
2. **支持全文搜索：** 文本索引支持跨字段关键词搜索
3. **相关性排序：** 自动计算并返回最相关的结果
4. **灵活过滤：** 支持多条件组合查询
5. **分页支持：** 支持大数据集的分页查询
6. **自动优化：** MongoDB 查询优化器自动选择最优索引





## 总结

快速索引功能通过以下方式实现：

1. **初始化阶段：** 在 `Store.init_collections()` 中创建多种索引
   - 单字段索引：加速精确查询
   - 文本索引：支持全文搜索
   - 多键索引：支持数组字段查询

2. **查询阶段：** 在 `Buyer.book_search_advanced()` 中使用索引
   - `$text` 查询触发文本索引
   - 组合条件利用多个索引协同工作
   - 相关性分数支持智能排序

3. **性能提升：** 索引将查询时间从毫秒级优化到微秒级，特别是在大数据集上效果显著

